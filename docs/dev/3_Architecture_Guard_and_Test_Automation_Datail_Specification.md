# 📑 [Krepis] 3. 검증: 아키텍처 가드 및 테스트 자동화 상세 명세

## 3.1 테스트 커버리지 및 강제성 (Hard-Fail Policy)

- **임계치 및 강제화:** 모든 패키지 및 애플리케이션의 테스트 커버리지는 **전
  레이어 80% 이상**을 필수 조건으로 합니다.
- **CI 차단:** `Vitest` 및 `Cargo`의 커버리지 리포트를 합산하여, 단 1%라도 80%에
  미달할 경우 **CI 파이프라인을 즉시 중단(Hard Fail)** 시키며 배포를 원천
  차단합니다. 이는 아키텍처의 견고성을 타협하지 않겠다는 강력한 의지입니다.

## 3.2 아키텍처 가드 및 순환 참조 (Architecture Guard)

- **순환 참조 제로:** 패키지 간, 혹은 모듈 간의 순환 참조는 설계 결함으로
  간주합니다. `dependency-cruiser`를 통해 감지 시 즉시 에러를 발생시킵니다.
- **레이어 침범 탐지:** `ESLint`와 커스텀 아키텍처 린트 규칙을 통해 상위
  레이어가 하위 레이어의 Impl(구체 클래스)에 의존하는 패턴을 실시간으로 감지하고
  빌드 타임에 차단합니다.

## 3.3 인프라 및 네이티브 테스트 전략

- **실제 환경 테스트 (Testcontainers):** Infrastructure 레이어 테스트 시
  Mocking을 지양하고, `Testcontainers`를 활용하여 Docker 환경에서 실제
  DB(Prisma/PostgreSQL) 및 Redis를 가동하여 테스트합니다. 이를 통해 "환경 차이로
  인한 장애"를 방지합니다.
- **Rust Native 테스트:** Rust 모듈은 `cargo test`를 통해 로컬 유닛 테스트를
  수행하며, TS 레이어에서는 `Vitest`를 통해 네이티브 바이너리의 통합
  인터페이스(NAPI)를 직접 호출하여 데이터 흐름의 정합성을 검증합니다.

## 3.4 CI 가속 및 안정성 관리 (Pipeline DX)

- **분산 병렬 실행:** 테스트 스위트를 도메인 및 레이어별로 그룹화하여 GitHub
  Actions Matrix를 통해 여러 러너(Runner)에서 분산 실행합니다. 이는 실행 속도를
  높일 뿐만 아니라, 실패 지점을 명확히 분리하여 디버깅을 가속화합니다.
- **Flaky Test 관리:** 간헐적으로 실패하는 테스트는 `vitest`의 retry 기능을
  활용하되, 3회 이상 재시도 시에도 불안정한 경우 자동으로 리포팅하고 해당
  테스트를 격리(Quarantine) 모드로 전환하여 신속한 수정을 유도합니다.

## 3.5 시각화 및 품질 지표 (Observability)

- **아키텍처 시각화:** 매 빌드 시 `dependency-cruiser`가 의존성 그래프를
  SVG/HTML 파일로 자동 생성합니다. 이 그래프는 프로젝트 문서 시스템에 자동
  업로드되어 모든 개발자가 레이어 구조를 시각적으로 즉시 파악할 수 있게 합니다.
- **종합 품질 리포트:** 커버리지 외에도 `Sonarqube` 또는 유사 도구와 연동하여
  코드 복잡도(Cyclomatic Complexity) 및 중복 코드를 수집, 정기적인 품질
  대시보드를 제공합니다.

## 3.6 부트스트랩 검증 (Runtime Validation)

- **DI 무결성 체크:** 애플리케이션 기동(Application Bootstrap) 시점에 DI
  컨테이너는 의존성 그래프를 전수 검사합니다.
- 순환 의존성(Circular Dependency) 존재 여부
- 모든 포트(Port/Interface)에 적절한 어댑터(Adapter/Impl)가 바인딩되었는지 여부
- 위 조건 미충족 시 애플리케이션은 실행되지 않고 명확한 에러 로그를 출력합니다.

---

## 🛠️ 검증 시스템 구성 요약

| 항목          | 검증 도구                    | 통제 방식              | 비고                  |
| ------------- | ---------------------------- | ---------------------- | --------------------- |
| **커버리지**  | Vitest (v8), Cargo-tarpaulin | **80% 미만 Hard Fail** | 전 레이어 공통 적용   |
| **순환 참조** | Dependency Cruiser           | 감지 시 즉시 빌드 중단 | 패키지/모듈 전체      |
| **인프라**    | Testcontainers (Docker)      | 실제 환경 정합성 검토  | DB, Cache 연동 테스트 |
| **시각화**    | Dep-cruise Graphviz          | SVG 자동 생성 및 배포  | 아키텍처 가시성 확보  |
| **DI 검증**   | Krepis Core DI Engine        | 런타임 부트스트랩 검사 | 의존성 누락 방지      |

---
